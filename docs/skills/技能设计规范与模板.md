# 技能设计规范与模板

目的：统一技能设计口径，便于后续在 Godot 4.4 项目中快速、一致地实现技能逻辑与表现。

## 命名与 ID 规范
- ID 规则：`skill.<scope>.<slug>.v1` 例如：`skill.hero.lifesteal.v1`、`skill.monster.howl.v1`
- scope：`hero`（队员）、`monster`（怪物）、`shared`（通用）
- slug：短横线或下划线分隔的小写英文，例如 `armor_break`、`poison_bite`

## 通用字段
- id：全局唯一技能 ID
- 名称：展示名称（中文）
- 类型：`active` | `passive` | `trigger`
- 触发时机：详见“触发时机与代码钩子”
- 目标：`self` | `ally` | `enemy` | `team_allies` | `team_enemies` | `all`
- 范围：`single` | `row` | `all` | 自定义（带数量上限）
- 冷却：整数回合，0 表示无冷却
- 持续：持续回合数（buff/debuff/持续效果）
- 可叠加：`true/false`，叠加上限：整数
- 优先级：同回合/同事件的解析顺序，数值越大越后应用
- 互斥组：同组内只能存在一个（用于同类状态互斥）
- 条件：触发与生效条件（示例：`hp_pct_below: 30`、`is_crit: true`）
- 标签：`["bleed","dot","melee","magic","defense"]`（用于检索与组合）
- 数值参数：按效果自定义（如 `rate`, `flat`, `duration`, `stacks_max`）
- 描述文本：玩家可读的描述
- 表现：`fx_id`、`sfx_id`、`flash_style`、`color`（与表现系统对接）

## 触发时机与代码钩子（实现映射）
结合当前项目结构，建议采用以下触发点：

- 攻击前：`on_attack_before_damage(attacker, target, ctx)`
  - 位置：`TeamBattleManager.gd` 计算伤害前
- 造成伤害后：`on_attack_after_damage(attacker, target, dmg_info, ctx)`
  - 位置：`TeamBattleManager.gd` 已生成 `dmg_info`，应用数值后
  - 现有案例：吸血在此时基于实际伤害进行治疗（参见 `heal = round(damage * rate)`）
- 受击前：`on_receive_before_damage(target, attacker, ctx)`
- 受击后：`on_receive_after_damage(target, attacker, dmg_info, ctx)`
- 回合开始/结束：`on_turn_start(unit, ctx)` / `on_turn_end(unit, ctx)`
- 击杀事件：`on_kill(attacker, victim, ctx)` / `on_death(unit, killer, ctx)`
- 战斗开始/结束：`on_battle_start(ctx)` / `on_battle_end(ctx)`

表现对接：
- 受击命中时刻：`BattleAnimationController.gd` 中的命中回调（已对齐定时器连接逻辑）
- 数字飘字/闪烁/特效：`BattleEffectsManager.gd`、`DamageNumber.gd`、`BattleAudioManager.gd`
- 建议在技能触发时广播：`GameManager.emit_signal("skill_triggered", skill_id, source, targets, context)`（如需要日志与可视化联动）

## 效果类型枚举（建议）
- 直接伤害：`damage`（`rate`/`flat`/`element`）
- 治疗：`heal`（`rate`/`flat`/`hot`）
- 吸血：`lifesteal`（基于实际造成伤害的百分比治疗）
- 护盾：`shield`（`amount`/`duration`/`stacking`）
- 强化/减益：`buff` / `debuff`（命中率、暴击率、暴击伤害、攻击、防御、速度等）
- 持续伤害：`dot`（`bleed`/`poison` 等）
- 控制：`stun`/`silence`/`taunt`/`disarm` 等
- 净化/驱散：`cleanse` / `dispel`
- 反弹：`reflect`
- 护甲相关：`armor_up` / `armor_break`
- 额外打击：`extra_hit` / `chain` / `splash`
- 召唤/制造：`summon` / `spawn`

## 数据结构建议（便于落地实现）
推荐采用 JSON/YAML 形式描述技能，并在运行时加载到资源或数据表中。

示例（YAML）：
```yaml
id: skill.hero.lifesteal.v1
name: 生命汲取
type: passive
scope: hero
triggers:
  - event: on_attack_after_damage
    conditions:
      - stat_check: { key: "hp_pct", op: "<=", value: 100 }
    effects:
      - type: lifesteal
        rate: 0.20   # 与 TeamBattleManager 中实现一致
visual:
  fx_id: fx_heal_green
  sfx_id: sfx_heal_soft
desc: "造成伤害后，治疗自身等于伤害的20%。"
tags: ["sustain","melee"]
```

示例（JSON）：
```json
{
  "id": "skill.monster.howl.v1",
  "name": "群狼嚎叫",
  "type": "trigger",
  "scope": "monster",
  "cooldown": 3,
  "triggers": [
    {
      "event": "on_turn_start",
      "conditions": [ { "round_mod": { "mod": 3, "eq": 0 } } ],
      "effects": [ { "type": "buff", "stat": "attack", "rate": 0.25, "duration": 2, "targets": "team_allies" } ]
    }
  ],
  "visual": { "fx_id": "fx_howl", "sfx_id": "sfx_howl" },
  "desc": "每3回合咆哮一次，使所有友方攻击提高25%，持续2回合。",
  "tags": ["support","aoe"]
}
```

## 可视化与音效约定
- `fx_id`：与 `BattleEffectsManager` 可解析的特效键一致
- `sfx_id`：与 `BattleAudioManager` 的音效键一致
- `flash_style`：与 `BattleAnimationController` 的受击/治疗闪烁样式一致（如 `hit_red`, `heal_green`）
- 数字飘字：`DamageNumber` 使用 `type: damage|heal|shield` 选择外观

## 模板（复制使用）
```yaml
id: skill.<hero|monster|shared>.<slug>.v1
name: 技能名称
type: active|passive|trigger
scope: hero|monster|shared
cooldown: 0
duration: 0
stackable: false
stack_limit: 0
priority: 0
mutex_group: ""
tags: []
triggers:
  - event: on_attack_before_damage|on_attack_after_damage|on_receive_before_damage|on_receive_after_damage|on_turn_start|on_turn_end|on_kill|on_death|on_battle_start|on_battle_end
    targets: self|ally|enemy|team_allies|team_enemies|all
    conditions: []
    effects:
      - type: damage|heal|lifesteal|shield|buff|debuff|dot|stun|cleanse|reflect|armor_break|armor_up|extra_hit
        rate: 0
        flat: 0
        stat: ""
        duration: 0
visual:
  fx_id: ""
  sfx_id: ""
  flash_style: ""
desc: 描述文本
```

## 落地实施建议
- 首先以 Markdown/JSON/YAML 在 `docs/skills` 目录完成定义与评审
- 确定固定触发点的解析顺序（先前置减伤/免疫，再应用伤害，再触发吸血/反击等）
- 在 `TeamBattleManager.gd` 内逐步接入：解析触发点、应用效果、发送可视化事件
- 在 `BattleAnimationController.gd`、`BattleEffectsManager.gd` 对齐 `fx_id/sfx_id` 与闪烁样式
- 保留 `skill_triggered` 日志/信号，便于测试与回放