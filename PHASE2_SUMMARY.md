# 第二阶段开发总结（Phase 2 Summary）

本文件用于总结与跟踪第二阶段“卡牌购买/刷新与体验优化（商店机制）”的范围、实现进度与验收情况；详细规则以《PRD.md》为唯一权威来源。

## 阶段范围（与 PRD 对齐）
- 展示可购买卡牌：每次生成 3 张；购买后立即移除，可继续购买或刷新。
- 货币与价格：使用 `灵石`；卡牌单独价格；余额不足禁用“购买”。
- 刷新机制：刷新价格递增（示例：5→10→15）；刷新后重新生成 3 张卡牌；余额不足禁用“刷新”。
- UI 要求：按钮文案含价格；价格与余额标签实时联动；购买/刷新禁用与提示准确。
- 重置规则：刷新价格在 PRD 约定的特定时机重置（如进入新商店或回宗门）。

## 关联模块与职责
- `GameManager.gd`：维护 `spirit_stones`；`add_resources/spend_resources/get_resource_amount`；发出 `resources_changed` 信号。
- `BattleManager.gd`：胜利奖励结算（普通/Boss 差异），通过 `GameManager` 发放灵石。
- `MainGameController.gd`：初始化并更新 `spirit_label`；监听资源变化刷新 UI。
- `CardSelectionWindow.gd`：价格显示、按钮文案与禁用、刷新价格递增、根据唯一 ID 移除已购卡、卡池刷新。

## 当前进度（截至最近提交）
- `spirit_stones` 资源：已在 `GameManager.gd` 管理，`MainGameController.gd` 显示余额。
- 战斗奖励：`BattleManager.gd` 按敌人类型发放灵石。
- 商店交互：`CardSelectionWindow.gd` 已具备基本购买与刷新逻辑，仍需完善价格文本、禁用逻辑与刷新价格递增/重置的细节实现与验证。

## 待完成事项（MVP 验收清单）
- 购买按钮：显示“购买（价格）”；余额不足禁用并提示。
- 刷新按钮：显示“刷新（价格）”；价格随次数递增；余额不足禁用。
- 已购卡移除：按唯一 ID 正确移除，避免 UI 索引错乱。
- 价格与余额联动：监听 `resources_changed`，确保标签即时更新。
- 边界与回归测试：多次购买与刷新；价格递增与重置；战斗→获得灵石→商店购买/刷新端到端验证。

## 风险与注意事项
- 刷新价格重置条件需与 PRD 一致；避免在错误时机重置导致经济异常。
- 按钮禁用与提示需统一文案与状态，保证玩家可理解性。
- 资源变更事件需去重，避免 UI 重复刷新或状态抖动。

## 里程碑与交付
- 里程碑：商店交互 MVP 可用；端到端流程通过；文档与代码注释完善。
- 交付物：完成的交互逻辑、基础测试脚本、更新的 README 快速指引（可选截图）。

## 参考
- 《PRD.md》第二阶段相关章节
- `README.md` 开发进度与模块概览