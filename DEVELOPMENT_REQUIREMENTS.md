# Loop Legend 开发需求文档

## 文档信息
- **项目名称**: Loop Legend (循环英雄传说)
- **文档版本**: v1.0
- **创建日期**: 2024年12月
- **最后更新**: 2024年12月
- **负责人**: 开发团队

## 1. 项目现状概述

### 1.1 当前开发阶段
**第一阶段已完成** (2024年12月)
- ✅ 项目基础架构搭建完成
- ✅ 核心管理器系统实现
- ✅ 基础循环机制运行正常
- ✅ 战斗窗口系统已集成
- ✅ 基础UI框架完成

### 1.2 技术栈
- **引擎**: Godot 4.4.1
- **编程语言**: GDScript
- **平台**: PC (Windows/Mac/Linux)
- **分辨率**: 1280x720 (可扩展)

### 1.3 已实现的核心系统

#### 管理器架构
- **GameManager**: 游戏状态管理、资源系统
- **LoopManager**: 循环路径、英雄移动、时间系统
- **CardManager**: 卡牌数据库、手牌管理
- **HeroManager**: 英雄属性、职业系统、升级机制
- **BattleManager**: 自动战斗、伤害计算、奖励分配
- **MainGameController**: 系统协调、UI更新

#### 用户界面
- **主游戏界面**: 资源显示、英雄信息、战斗日志、手牌区域
- **战斗窗口**: 可视化战斗界面，实时状态显示
- **时间系统UI**: 天数显示、步数进度条

#### 核心玩法
- **循环系统**: 12瓦片圆形路径，英雄自动移动
- **卡牌系统**: 4种卡牌类型，放置机制
- **战斗系统**: 回合制自动战斗，伤害计算
- **资源系统**: 5种资源类型管理

## 2. 第二阶段开发需求 (当前阶段)

### 2.1 阶段目标
**核心玩法完善与内容扩展** (预计6-8周)

### 2.2 优先级分类
- **P0 (必须)**: 核心玩法完善，确保游戏可玩性
- **P1 (重要)**: 用户体验优化，视觉效果提升
- **P2 (可选)**: 高级功能，扩展内容

### 2.3 具体开发需求

#### 2.3.1 战斗系统完善 (P0)

**需求描述**: 扩展战斗系统，增加更多战斗机制和平衡性

**技术要求**:
- 扩展 `BattleManager.gd` 战斗逻辑
- 实现技能系统框架
- 添加状态效果系统 (毒、燃烧、冰冻等)
- 优化伤害计算公式

**具体任务**:
1. **技能系统实现**
   - 为每个职业添加2-3个主动技能
   - 实现技能冷却机制
   - 添加技能效果动画

2. **状态效果系统**
   - 创建 `StatusEffect` 类
   - 实现DOT (持续伤害) 效果
   - 添加增益/减益状态

3. **战斗平衡调整**
   - 调整各职业基础属性
   - 平衡敌人强度曲线
   - 优化装备属性加成

**验收标准**:
- [ ] 每个职业至少有2个可用技能
- [ ] 状态效果正确显示和计算
- [ ] 战斗胜率在合理范围内 (60-80%)

#### 2.3.2 卡牌系统扩展 (P0)

**需求描述**: 增加更多卡牌类型和组合效果

**技术要求**:
- 扩展 `CardManager.gd` 卡牌数据库
- 实现卡牌相邻效果系统
- 添加卡牌组合检测机制

**具体任务**:
1. **新增卡牌类型**
   - 地形卡: 沼泽、山脉、河流 (各3张)
   - 建筑卡: 铁匠铺、图书馆、神庙 (各2张)
   - 敌人卡: 兽人营地、巨魔洞穴 (各2张)
   - 特殊卡: 传送门、祭坛 (各1张)

2. **相邻效果系统**
   - 实现卡牌相邻检测算法
   - 添加相邻效果触发机制
   - 创建效果叠加规则

3. **组合效果系统**
   - 定义卡牌组合规则
   - 实现组合效果检测
   - 添加组合效果UI提示

**验收标准**:
- [ ] 至少20张不同卡牌可用
- [ ] 相邻效果正确触发
- [ ] 至少5种卡牌组合效果

#### 2.3.3 装备系统实现 (P0)

**需求描述**: 完善装备系统，增加装备掉落和管理

**技术要求**:
- 扩展 `HeroManager.gd` 装备管理
- 创建装备数据结构
- 实现装备UI界面

**具体任务**:
1. **装备数据结构**
   - 创建 `Equipment` 类
   - 定义装备类型和品质
   - 实现装备属性加成

2. **装备掉落系统**
   - 在 `BattleManager.gd` 中添加掉落逻辑
   - 实现装备稀有度权重
   - 添加装备掉落动画

3. **装备管理UI**
   - 创建装备栏界面
   - 实现装备拖拽功能
   - 添加装备属性显示

**验收标准**:
- [ ] 6个装备槽位可用
- [ ] 装备正确影响英雄属性
- [ ] 装备掉落率合理 (10-30%)

#### 2.3.4 营地系统基础 (P1)

**需求描述**: 实现基础营地管理功能

**技术要求**:
- 创建新的营地场景
- 实现建筑系统框架
- 添加营地UI界面

**具体任务**:
1. **营地场景创建**
   - 设计营地布局
   - 创建 `CampManager.gd`
   - 实现场景切换逻辑

2. **建筑系统**
   - 定义建筑类型和功能
   - 实现建筑升级机制
   - 添加建筑解锁条件

3. **资源消耗系统**
   - 实现建筑成本计算
   - 添加资源不足提示
   - 优化资源获取平衡

**验收标准**:
- [ ] 营地界面可正常访问
- [ ] 至少3种建筑可建造
- [ ] 建筑功能正确生效

#### 2.3.5 视觉效果优化 (P1)

**需求描述**: 提升游戏视觉体验和动画效果

**技术要求**:
- 优化现有动画系统
- 添加粒子特效
- 改进UI视觉设计

**具体任务**:
1. **战斗动画优化**
   - 改进战斗窗口动画
   - 添加技能释放特效
   - 优化伤害数字显示

2. **UI动画效果**
   - 添加卡牌放置动画
   - 实现按钮悬停效果
   - 优化界面过渡动画

3. **环境特效**
   - 添加背景粒子效果
   - 实现天气系统视觉
   - 优化光照效果

**验收标准**:
- [ ] 所有动画流畅运行 (60FPS)
- [ ] 特效不影响游戏性能
- [ ] UI响应时间 < 100ms

#### 2.3.6 音频系统实现 (P2)

**需求描述**: 添加背景音乐和音效系统

**技术要求**:
- 创建 `AudioManager.gd`
- 实现音频资源管理
- 添加音频设置界面

**具体任务**:
1. **音频管理器**
   - 实现音频播放控制
   - 添加音量调节功能
   - 实现音频淡入淡出

2. **音效集成**
   - 添加UI交互音效
   - 实现战斗音效
   - 添加环境音效

3. **背景音乐**
   - 实现场景音乐切换
   - 添加循环播放逻辑
   - 优化音频文件大小

**验收标准**:
- [ ] 背景音乐正常播放
- [ ] 音效与动作同步
- [ ] 音频设置可保存

## 3. 技术规范

### 3.1 代码规范

#### 文件命名
- 脚本文件: `PascalCase.gd` (如: `CardManager.gd`)
- 场景文件: `PascalCase.tscn` (如: `MainGame.tscn`)
- 资源文件: `snake_case` (如: `hero_sprite.png`)

#### 代码风格
- 使用Tab缩进 (4空格)
- 函数名: `snake_case`
- 变量名: `snake_case`
- 常量名: `UPPER_SNAKE_CASE`
- 类名: `PascalCase`

#### 注释规范
```gdscript
# 单行注释说明函数用途
func calculate_damage(attacker: Hero, defender: Enemy) -> int:
	"""计算伤害值
	
	Args:
		attacker: 攻击者英雄
		defender: 防御者敌人
		
	Returns:
		int: 最终伤害值
	"""
	pass
```

### 3.2 架构规范

#### 信号使用
- 使用信号实现模块间通信
- 避免直接调用其他管理器的方法
- 信号命名: `action_completed` 格式

#### 数据管理
- 使用Resource类存储游戏数据
- 避免在脚本中硬编码数据
- 实现数据序列化和反序列化

#### 性能优化
- 使用对象池管理频繁创建的对象
- 避免在 `_process()` 中进行复杂计算
- 合理使用 `queue_redraw()` 更新UI

### 3.3 测试规范

#### 单元测试
- 为核心逻辑编写单元测试
- 使用Godot的GUT测试框架
- 测试覆盖率 > 70%

#### 集成测试
- 测试管理器间的信号通信
- 验证UI与逻辑的同步
- 测试游戏流程完整性

#### 性能测试
- 监控帧率稳定性
- 测试内存使用情况
- 验证加载时间

## 4. 开发流程

### 4.1 版本控制
- 使用Git进行版本控制
- 主分支: `main`
- 开发分支: `develop`
- 功能分支: `feature/功能名称`
- 修复分支: `hotfix/问题描述`

### 4.2 提交规范
```
type(scope): description

[optional body]

[optional footer]
```

**类型说明**:
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

### 4.3 代码审查
- 所有代码必须经过审查
- 审查重点: 功能正确性、代码质量、性能影响
- 使用Pull Request进行代码合并

## 5. 质量保证

### 5.1 测试策略

#### 功能测试
- [ ] 核心循环机制测试
- [ ] 卡牌放置和效果测试
- [ ] 战斗系统测试
- [ ] UI交互测试
- [ ] 数据保存和加载测试

#### 性能测试
- [ ] 帧率稳定性测试 (目标: 60FPS)
- [ ] 内存使用测试 (目标: <500MB)
- [ ] 加载时间测试 (目标: <5秒)

#### 兼容性测试
- [ ] Windows 10/11 测试
- [ ] 不同分辨率测试
- [ ] 不同硬件配置测试

### 5.2 Bug管理

#### 优先级定义
- **P0 (阻塞)**: 游戏无法启动或崩溃
- **P1 (严重)**: 核心功能无法使用
- **P2 (一般)**: 功能异常但有替代方案
- **P3 (轻微)**: 界面问题或小的功能缺陷

#### Bug报告格式
```
标题: [模块] 简短描述

重现步骤:
1. 步骤1
2. 步骤2
3. 步骤3

期望结果: 描述期望的正确行为
实际结果: 描述实际发生的问题
环境信息: 操作系统、Godot版本等
附件: 截图或日志文件
```

## 6. 发布计划

### 6.1 里程碑时间表

| 里程碑 | 时间节点 | 主要成果 |
|--------|----------|----------|
| M2.1 | Week 8 | 战斗系统完善 |
| M2.2 | Week 10 | 卡牌系统扩展 |
| M2.3 | Week 12 | 装备系统实现 |
| M2.4 | Week 14 | 营地系统基础 |

### 6.2 版本发布

#### Alpha版本 (Week 14)
- 核心玩法完整
- 基础内容可玩
- 内部测试版本

#### Beta版本 (Week 20)
- 所有功能实现
- 美术资源完整
- 公开测试版本

#### 正式版本 (Week 24)
- 所有Bug修复
- 性能优化完成
- 正式发布版本

## 7. 风险管理

### 7.1 技术风险

#### 性能风险
- **风险**: 复杂特效导致帧率下降
- **应对**: 实现特效开关，优化渲染管线

#### 兼容性风险
- **风险**: 不同平台表现不一致
- **应对**: 早期多平台测试，建立测试环境

### 7.2 进度风险

#### 功能范围风险
- **风险**: 功能需求不断增加
- **应对**: 严格按照PRD执行，控制需求变更

#### 资源依赖风险
- **风险**: 美术资源制作延期
- **应对**: 使用占位资源，并行开发

### 7.3 质量风险

#### 测试不充分风险
- **风险**: 发布版本存在严重Bug
- **应对**: 预留充足测试时间，建立测试流程

## 8. 成功指标

### 8.1 开发指标
- **代码质量**: 无P0/P1级别Bug
- **性能指标**: 60FPS稳定运行
- **测试覆盖**: 核心功能测试覆盖率 > 90%

### 8.2 用户体验指标
- **学习曲线**: 新手5分钟内掌握基础操作
- **游戏时长**: 单次游戏时长 > 20分钟
- **稳定性**: 崩溃率 < 1%

### 8.3 项目管理指标
- **进度控制**: 里程碑按时完成率 > 90%
- **质量控制**: Bug修复及时率 > 95%
- **团队效率**: 代码审查通过率 > 85%

---

**文档维护**:
- 本文档将根据开发进度定期更新
- 所有变更需要团队评审确认
- 版本历史记录在Git中维护

**联系方式**:
- 技术问题: 开发团队
- 需求变更: 产品负责人
- 进度跟踪: 项目经理