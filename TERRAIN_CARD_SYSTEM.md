# 地形卡牌系统设计文档

版本：v1.0  
适用项目：Loop Hero（整合《冒险与挖矿》整体回合战斗系统）  
作者：项目组  

## 1. 概述
地形卡牌系统用于在循环路径周边放置不同类型的地形牌，以动态改变关卡生成、资源产出与战斗属性。玩家通过“抽牌—选择—放置—结算”的闭环驱动地图演化与策略选择。

核心目标：
- 强化路径与周边环境对“队伍战斗”的直接影响（怪物生成、属性光环、技能概率修正）。
- 提供清晰的放置规则与组合联动，形成明显的战术流派与地图构筑玩法。
- 技术上与TileMapLayer、卡牌系统和战斗系统无缝集成，支持数据驱动和可扩展性。

### 术语约定：每日卡牌类型
- 环境：影响地形、光环与资源的环境类卡牌（对应景观/光环/部分特殊地形）。
- 禁地：在相邻或范围格生成敌人的场域型卡牌（原“刷怪类型”）。
- 道友：召唤或加入战斗的助战单位（原“战斗队友类型”）。

## 2. 数据与架构
数据结构（建议JSON或Godot Resource）：
- id：字符串，唯一标识
- name：名称
- rarity：稀有度（common/rare/epic/legend）
- category：类别（path/roadside/landscape/aura/special）
- placement_mask：放置掩码（path_only/adjacent_to_path/any/edge）
- adjacency_requirements：邻接要求（如：靠近玄灵湖、灵脉群峰，或至少n个同类）
- stack_limit：同一格最大叠加数
- tile_render：渲染信息（layer_name、tile_id/atlas、z_index）
- effects：效果集合
  - spawn_table：生成表（敌人类型、等级系数、生成概率、最大存量、冷却）
  - battle_modifiers：战斗修正（范围、属性百分比、技能触发率修正、状态概率修正）
  - resource_modifiers：资源产出（木/矿/食物/信仰等，按日/回合/触发事件结算）
  - event_hooks：事件钩子（放置时、被移除时、怪物死亡时、战斗开始/结束时）
- synergy_rules：联动规则（与其他地形或组合牌的交互）

示例（简化）：
{
  "id": "forest",
  "name": "灵林",
  "rarity": "common",
  "category": "roadside",
  "placement_mask": "adjacent_to_path",
  "stack_limit": 1,
  "effects": {
    "spawn_table": [{"enemy": "wolf", "rate": 0.25, "level_scale": 1.0, "max": 2, "cooldown_loops": 1}],
    "battle_modifiers": {"radius": 1, "atk_pct": 0.05, "dodge_pct": 0.03},
    "resource_modifiers": {"wood": {"per_loop": 1}}
  },
  "synergy_rules": [{"with": "zhumu_nest", "result": "mist_forest", "note": "生成概率提升与闪避提高"}]
}

## 3. 放置规则
- 放置时机：探索阶段与战斗间隙可放置；教程中限制为指定时机。
- 类别与掩码：
  - path：仅可放在路径格（影响经过该格的战斗与事件）。
  - roadside：仅可放在路径相邻格（影响邻近路径战斗与生成）。
  - landscape：任意可用格（多为资源或全局缓慢光环）。
  - aura：范围型光环，可放任意格但有半径与上限限制。
  - special：组合或异常地形，通常由联动触发生成。
- 邻接与叠加：遵从adjacency_requirements与stack_limit；同类地形一般不可叠加。
- 冲突与覆盖：同一格只允许一种“主地形”，可叠加“装饰/光环”类；出现冲突时优先级：path > special > aura > roadside > landscape。
- 成本与稀有度：放置消耗手牌与资源（或次数）；高稀有度牌通常更强但受上限或冷却约束。

## 4. 地形分类与设计清单（首批）
- 路面（path）
  - 凡尘坊市：经过时回复，战斗中提供少量王者与防御；有小概率触发“巡逻修士”事件。
  - 仙祀祭坛：战斗开始赋予队伍“仙缘祝福”（先攻+技能触发率微增），但提升敌人质量。
  - 上古遗迹：提高遭遇强敌概率，掉落质量更好，风险/收益并存。
- 路边（roadside）
  - 灵林：生成妖狼等灵兽；提供少量攻击和闪避光环。
  - 蛛妖巢：生成蛛妖；提供攻速（先攻）微增，但降低防御。
  - 护道灵塔：战前造成少量穿透伤害；对飞行/邪祟敌人效果提升。
- 景观（landscape）
  - 灵田：每回合少量回复；与凡尘坊市邻接时额外恢复。
  - 灵脉群峰：提供队伍“王者”与防御提升；叠加后可触发“天脉之巅”特殊地形。
  - 玄灵湖：灵水充沛，提升治疗类技能效果，降低火属性技能伤害。
  - 玄铁矿脉：提高矿产资源产出；进入战斗时提供小幅防御。
- 光环（aura）
  - 玄阳碑：固定半径提升先攻与技能触发率（小幅），对亡灵/邪祟敌人减益。
  - 幽冥阴域：提升暴击但降低防御，适合高回避/爆发流派。
- 特殊与组合（special）
  - 仙雾海：灵脉群峰+玄灵湖邻接触发；提供高闪避与治疗优化，但降低技能伤害。
  - 幻雾灵林：灵林+蛛妖巢邻接触发；生成更强的混合敌人与更高资源掉落。
  - 朝仙古道：凡尘坊市+仙祀祭坛联动；祝福加强，但路径遭遇更频繁。

## 5. 战斗交互规则
- 影响范围：
  - path地形对该格战斗100%生效；roadside以曼哈顿距离1格生效；aura按配置半径生效。
- 修正规则：同类数值叠加按加法或乘法明确：
  - 属性加成（atk/def/crit/dodge/王者/先攻）：同源加法，异源乘法（防止数值爆炸）。
  - 技能触发率修正：上限封顶（如≤+20%相对提升），并在结算前统一计算。
  - 状态概率修正：按“基础概率×（1+修正）”计算，设置上限与抗性下限。
- 生成与战斗：地形生成的敌人有标签（来源地形id），用于掉落与AI策略差异化。

## 6. 资源与事件
- 产出模型：按循环（loop）或日夜（tick）结算，支持放置即时奖励与移除惩罚。
- 事件钩子：
  - on_place：播放特效、即时奖励、检查组合生成。
  - on_battle_start：注入战斗修正与光环。
  - on_enemy_death：额外掉落或计数任务。
  - on_remove：返还部分资源或触发负面事件。

## 7. UI与交互流程
- 卡牌选择窗口：显示可用地形牌、稀有度、效果预览与放置掩码。
- 放置流程：拖拽到目标格—显示合法掩码高亮—预览效果—确认放置。
- 反馈与提示：
  - 非法放置给出原因（类别/邻接/叠加/冲突）。
  - 组合生成时弹出提示并展示新地形效果。
  - 地形光环范围在鼠标悬停时可视化圈出。

## 8. 技术实现（Godot 4.4）
- 地图：使用TileMapLayer替代旧TileMap，区分基础路径层、路边层、景观层、光环层，统一通过数据驱动渲染。
- 数据：TerrainCardData资源（或JSON）加载到CardManager，运行时校验placement_mask与邻接。
- 交互：CardSelectionWindow负责拖拽与校验，高亮合法格；确认后调用Game/Loop管理器刷新地图与地形实例表。
- 战斗：进入战斗时，由BattleManager从当前位置与周边地形收集battle_modifiers并应用到队伍与敌方。

## 9. 平衡与进度
- 稀有度与上限：legend类地形限制全局数量或冷却；aura类限制半径与层数。
- 成本：高级牌消耗更高资源或占用手牌上限；移除地形需付费或有风险。
- 进度解锁：通过宗门系统升级解锁更高级地形与组合。

## 10. 测试要点
- 放置合法性：各类别掩码、邻接、叠加与冲突验证。
- 生成与结算：spawn_table数量与冷却、资源产出与事件钩子。
- 战斗修正：属性、技能触发率与状态概率上限控制；多光环叠加正确结算。
- 组合链：三种以上联动的正确触发与覆盖优先级。
- 性能：大量地形叠加下的渲染与战斗数据收集性能。