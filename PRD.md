# Loop Hero 类循环冒险游戏 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目名称
**循环英雄传说** (Loop Legend)

### 1.2 项目简介
一款基于Godot 4.4引擎开发的Loop Hero类循环冒险游戏，融合了Roguelike、卡牌策略和自动战斗元素。玩家通过放置地形和建筑卡牌来影响英雄的循环冒险，收集资源建设营地，最终打破邪恶的时间循环。

### 1.3 目标平台
- PC (Windows/Mac/Linux)
- 移动端 (Android/iOS) - 后期扩展

### 1.4 开发周期
预计开发周期：6-8个月

## 2. 游戏核心机制

### 2.1 循环系统
- **循环路径**：英雄在基于TileMapLayer的瓦片路径上自动行走，支持自定义路径设计
- **路径类型**：支持圆形路径（fallback）和自定义瓦片路径（主要使用）
- **自动战斗**：遇到敌人时自动进行战斗
- **循环计数**：每完成一圈增加循环次数，敌人强度递增
- **撤退机制**：玩家可随时选择撤退，保留部分资源

### 2.1.1 时间系统
- **步数计数**：英雄每移动一个瓦片计为1步
- **天数系统**：每走20步为1天，天数影响游戏进程
- **步数进度条**：界面左上角显示当前步数进度（0-20步）
- **天数显示**：界面显示当前天数，每20步后天数+1，进度条重置
- **时间影响**：天数变化会触发特定游戏事件和机制

### 2.1.2 怪物生成系统
- **定时刷新**：每过1天（20步），地图路径上刷新1次怪物
- **怪物显示**：地图路径上的怪物以可视化图标显示
- **怪物分布**：怪物随机分布在循环路径的不同位置
- **怪物强度**：怪物强度随天数递增
- **怪物类型**：根据当前天数和循环次数决定怪物类型

### 2.2 卡牌系统
#### 2.2.1 卡牌类型
- **地形卡牌**：山脉、森林、沼泽、沙漠等
- **建筑卡牌**：村庄、塔楼、营地、神庙等
- **敌人卡牌**：哥布林营地、骷髅墓地、蜘蛛巢穴等
- **特殊卡牌**：宝藏、传送门、祭坛等

#### 2.2.2 卡牌效果
- **相邻效果**：卡牌之间的相互作用
- **组合效果**：特定卡牌组合产生额外效果
- **全局效果**：影响整个循环的效果

### 2.3 英雄系统
#### 2.3.1 职业类型
- **战士**：高血量，近战攻击
- **盗贼**：高闪避，暴击伤害
- **法师**：魔法攻击，法术效果
- **死灵法师**：召唤骷髅，生命汲取

#### 2.3.2 属性系统
- 生命值 (HP)
- 攻击力 (ATK)
- 防御力 (DEF)
- 攻击速度 (AS)
- 暴击率 (CRIT)
- 闪避率 (EVA)
- 魔法抗性 (MR)

### 2.4 装备系统
#### 2.4.1 装备类型
- 武器
- 护甲
- 头盔
- 靴子
- 饰品
- 盾牌

#### 2.4.2 装备品质
- 普通 (白色)
- 稀有 (蓝色)
- 史诗 (紫色)
- 传说 (橙色)

### 2.5 营地系统
#### 2.5.1 建筑类型
- **英雄大厅**：解锁新职业
- **训练场**：提升基础属性
- **图书馆**：解锁新卡牌
- **铁匠铺**：装备强化
- **炼金实验室**：药水制作
- **仓库**：扩展存储空间

#### 2.5.2 资源类型
- **木材**：基础建筑材料
- **石材**：高级建筑材料
- **金属**：装备制作材料
- **魔法水晶**：魔法相关材料
- **食物**：恢复生命值

## 3. 游戏流程

### 3.1 单次循环流程
1. **准备阶段**：选择英雄职业，配置初始卡组
2. **探索阶段**：英雄自动在循环路径上行走
3. **卡牌放置**：玩家根据情况放置卡牌
4. **战斗阶段**：英雄与敌人自动战斗
5. **收集阶段**：获得装备、资源和新卡牌
6. **决策阶段**：选择继续循环或撤退

### 3.2 整体游戏流程
1. **教程关卡**：学习基础操作
2. **第一章**：森林地区，基础敌人
3. **第二章**：山脉地区，中级敌人
4. **第三章**：沙漠地区，高级敌人
5. **第四章**：地下城，精英敌人
6. **最终章**：时间神殿，终极Boss

## 4. 用户界面设计

### 4.1 主界面
- 游戏标题
- 开始游戏按钮
- 营地管理按钮
- 设置按钮
- 退出按钮

### 4.2 游戏界面
- **循环路径区域**：显示英雄位置、已放置的卡牌和怪物图标
- **卡牌手牌区域**：显示当前可用卡牌
- **英雄状态区域**：显示英雄属性和装备
- **资源显示区域**：显示当前资源数量
- **时间系统区域**：界面左上角显示步数进度条和天数
  - **步数进度条**：显示当前步数进度（0-20步），每20步填满
  - **天数显示**：显示当前天数，格式为"第X天"
- **控制按钮区域**：撤退、暂停等按钮

### 4.3 营地界面
- **建筑布局区域**：显示营地建筑
- **资源管理区域**：资源数量和用途
- **英雄管理区域**：英雄选择和升级
- **卡牌收藏区域**：已解锁的卡牌

## 5. 技术需求

### 5.1 Godot 4.4 特性利用
- **场景系统**：模块化游戏场景管理
- **信号系统**：事件驱动的游戏逻辑
- **资源系统**：高效的资产管理
- **动画系统**：流畅的UI和游戏动画
- **音频系统**：背景音乐和音效管理
- **TileMapLayer系统**：Godot 4.3+新增，取代传统TileMap节点，提供更灵活的瓦片地图管理，支持多层级地图渲染，适用于循环路径和地形卡牌的可视化实现

### 5.2 核心系统架构
- **游戏管理器**：总体游戏状态管理
- **循环管理器**：循环逻辑和英雄移动
- **卡牌管理器**：卡牌系统和效果处理
- **战斗管理器**：自动战斗逻辑
- **资源管理器**：资源收集和消耗
- **存档管理器**：游戏进度保存

### 5.3 数据结构设计
- **英雄数据**：职业、属性、装备、技能
- **卡牌数据**：类型、效果、稀有度、解锁条件
- **装备数据**：属性加成、特殊效果、品质
- **敌人数据**：属性、AI行为、掉落物品
- **关卡数据**：地图布局、敌人配置、奖励设置

## 6. 美术需求

### 6.1 美术风格
- **像素艺术风格**：16x16或32x32像素精灵
- **暗黑奇幻主题**：神秘、阴郁的视觉氛围
- **简洁UI设计**：清晰易懂的界面元素

### 6.2 美术资源
- **英雄精灵**：4个职业的行走和战斗动画
- **敌人精灵**：各种怪物的动画
- **地形贴图**：草地、山脉、沙漠等
- **建筑精灵**：村庄、塔楼等建筑
- **UI元素**：按钮、面板、图标等
- **特效动画**：战斗特效、魔法效果

## 7. 音频需求

### 7.1 背景音乐
- 主菜单音乐
- 循环探索音乐
- 营地管理音乐
- Boss战斗音乐

### 7.2 音效
- 卡牌放置音效
- 战斗音效
- UI交互音效
- 环境音效

## 8. 平衡性设计

### 8.1 难度曲线
- **渐进式难度**：随循环次数增加敌人强度
- **风险收益平衡**：高风险区域提供更好奖励
- **多样化策略**：不同卡牌组合的可行性

### 8.2 经济平衡
- **资源获取速度**：确保合理的进度节奏
- **建筑成本设计**：平衡投入产出比
- **装备掉落率**：保持玩家期待感

## 9. 扩展性考虑

### 9.1 DLC内容
- 新的英雄职业
- 新的地图区域
- 新的卡牌类型
- 新的游戏模式

### 9.2 多人模式
- 合作模式：多人共同完成循环
- 竞技模式：比较循环完成效率

## 10. 阶段开发计划

### 10.1 开发阶段概览

总开发周期：**6-8个月**  
团队规模：**2-4人**（程序员、美术、策划、音频）

### 10.2 第一阶段：项目准备与核心框架 (4-6周)

#### 10.2.1 目标
- 搭建项目基础架构
- 实现核心循环机制
- 完成基础UI框架

#### 10.2.2 主要任务
- **Week 1-2：项目初始化**
  - Godot 4.4项目创建和配置
  - 版本控制系统搭建
  - 基础场景结构设计
  - 核心管理器类架构设计

- **Week 3-4：循环系统开发**
  - 英雄自动移动系统
  - 循环路径生成和管理
  - 基础战斗系统框架
  - 简单的敌人AI

- **Week 5-6：卡牌系统基础**
  - 卡牌数据结构设计
  - 卡牌放置机制
  - 基础地形卡牌效果
  - UI交互系统

#### 10.2.3 交付物
- 可运行的原型Demo
- 基础循环和卡牌放置功能
- 技术架构文档

### 10.3 第二阶段：《冒险与挖矿》整体回合战斗系统实现 (8-10周)

#### 10.3.1 目标
- 实现《冒险与挖矿》风格的队伍整体回合战斗系统
- 完善多角色队伍管理和技能系统
- 集成被动技能和组合技能机制
- 建立完整的战术流派支持

#### 10.3.2 主要任务

- **Week 7-8：队伍整体战斗系统核心框架**
  - 重构BattleManager为TeamBattleManager
  - 实现队伍整体回合制逻辑（1-25人队伍支持）
  - 开发技能触发顺序机制（按队伍顺序判定）
  - 实现"有技能触发则释放，无技能触发则整队普攻"的核心逻辑
  - 建立基础的SkillSystem框架

- **Week 9-10：主动技能系统实现**
  - 实现6种主动技能类型：
    - 暴击技能（高伤害，前期优势）
    - 纯粹技能（稳定伤害，中后期优势）
    - 回复技能（队伍生命值恢复）
    - 吸血技能（伤害+回复）
    - 大伤害技能（高倍率，低概率）
    - 百分比技能（按敌人血量百分比）
  - 完善技能触发概率系统
  - 实现技能效果的可视化反馈

- **Week 11-12：被动技能与四维属性系统**
  - 实现四维属性系统（先攻、防御、闪避、王者）
  - 开发被动技能框架：
    - 属性加成类被动技能
    - 特殊效果类被动技能（抗性、伤害修正等）
  - 集成被动技能到战斗计算中
  - 实现被动技能的战斗开始时自动生效机制

- **Week 13-14：组合技能与战术流派系统**
  - 实现组合技能系统（五虎上将、万事屋等）
  - 开发三大战术流派支持：
    - 先攻暴击流
    - 高防回复流  
    - 纯粹流
  - 完善伤害计算公式（含被动加成、防御减免等）
  - 实现队伍配置和角色排序界面

- **Week 15-16：多角色英雄系统扩展**
  - 扩展HeroManager支持多角色队伍管理
  - 实现角色招募和队伍编成系统
  - 开发角色技能配置界面
  - 集成角色成长和技能解锁机制
  - 实现角色卡牌系统（招募新角色）

#### 10.3.3 核心技术实现

##### 10.3.3.1 TeamBattleManager架构
```gdscript
# 核心战斗管理器，替换原有BattleManager
class_name TeamBattleManager
extends Node

var hero_team: Array[Dictionary] = []  # 支持1-25人队伍
var enemy_team: Array[Dictionary] = []
var current_turn: int = 0
var battle_phase: BattlePhase

# 核心方法
func execute_turn()  # 执行整体回合逻辑
func check_skill_triggers() -> Dictionary  # 按顺序检查技能触发
func execute_team_attack()  # 整队普攻
```

##### 10.3.3.2 技能触发机制
```
每回合执行流程：
1. 先攻判定 → 确定行动方
2. 技能触发判定 → 按队伍顺序（1号位→25号位）逐个判定
3. 技能执行 → 一旦触发立即释放，后续角色不再判定
4. 普攻执行 → 若无技能触发，整队普攻
5. 伤害结算 → 应用被动技能加成
```

##### 10.3.3.3 被动技能集成
```
战斗开始时：
- 所有被动技能自动生效
- 四维属性加成计算
- 特殊抗性和效果激活
- 组合技能检测和激活
```

#### 10.3.4 与现有系统的集成

##### 10.3.4.1 保留的系统
- 基础战斗管理器框架和信号系统
- UI交互接口和战斗窗口
- 资源管理和奖励系统

##### 10.3.4.2 重构的系统  
- 单体回合制 → 队伍整体回合制
- 简单攻击 → 复杂技能系统
- 单角色 → 多角色队伍管理

##### 10.3.4.3 新增的系统
- SkillSystem（技能管理）
- PassiveEffectManager（被动效果管理）
- TeamCompositionManager（队伍配置管理）
- ComboSkillSystem（组合技能系统）

#### 10.3.5 交付物
- 完整的《冒险与挖矿》风格队伍战斗系统
- 支持1-25人队伍的战斗Demo
- 6种主动技能类型完整实现
- 被动技能和四维属性系统
- 组合技能和战术流派支持
- 多角色队伍管理界面
- 详细的战斗系统技术文档

#### 10.3.6 测试重点
- 技能触发概率和顺序的准确性
- 被动技能效果的正确应用
- 不同队伍配置的战斗平衡性
- 组合技能的触发条件验证
- 战术流派的可行性测试

### 10.4 第三阶段：营地系统与内容制作 (4-6周)

#### 10.4.1 目标
- 实现营地管理系统
- 制作游戏关卡内容
- 美术资源集成
- 音频系统实现

#### 10.4.2 主要任务
- **Week 17-18：营地系统实现**
  - 营地建筑系统
  - 资源管理机制
  - 建筑升级和解锁
  - 营地UI界面
  - 角色招募和管理界面

- **Week 19-20：关卡设计与美术集成**
  - 多章节关卡设计
  - Boss战设计和实现（集成新战斗系统）
  - 难度曲线调整
  - 像素艺术资源制作
  - UI美术优化和战斗特效

- **Week 21-22：音频系统与内容完善**
  - 背景音乐集成
  - 音效系统实现（战斗技能音效）
  - 教程关卡制作
  - 卡牌系统扩展（角色卡牌、技能卡牌）

#### 10.4.3 交付物
- 完整的营地管理系统
- 多章节游戏内容
- 美术和音频资源
- 集成新战斗系统的Alpha版本

### 10.5 第四阶段：测试与发布准备 (2-4周)

#### 10.5.1 目标
- 全面测试和Bug修复
- 战斗系统平衡性调优
- 性能优化
- 发布准备

#### 10.5.2 主要任务
- **Week 23-24：测试阶段**
  - 功能测试和Bug修复
  - 战斗系统平衡性测试和调整
  - 技能触发概率验证
  - 不同队伍配置的胜率统计
  - 性能优化

- **Week 25-26：发布准备**
  - 最终版本打包
  - 发布平台准备
  - 宣传材料制作
  - 技术文档整理

#### 10.5.3 交付物
- 正式发布版本
- 用户手册
- 完整的战斗系统技术文档

### 10.6 里程碑时间表

| 里程碑 | 时间节点 | 主要成果 |
|--------|----------|----------|
| M1 | Week 6 | 核心循环Demo完成 |
| M2 | Week 16 | 《冒险与挖矿》战斗系统Alpha版本 |
| M3 | Week 22 | 内容完整Beta版本 |
| M4 | Week 26 | 正式发布版本 |

### 10.7 风险管控

#### 10.7.1 技术风险
- **Godot引擎学习曲线**：预留额外学习时间
- **性能优化问题**：定期性能测试
- **平台兼容性**：早期多平台测试

#### 10.7.2 进度风险
- **功能范围蔓延**：严格按PRD执行
- **美术资源延期**：提前启动美术制作
- **测试时间不足**：预留充足测试时间

#### 10.7.3 应对策略
- 每周进度评估和调整
- 关键功能优先开发
- 保持最小可行产品(MVP)思维

## 11. 成功指标

### 11.1 核心指标
- **留存率**：7日留存 > 30%
- **游戏时长**：平均单次游戏 > 30分钟
- **完成率**：主线完成率 > 60%

### 11.2 用户体验指标
- **学习曲线**：新手教程完成率 > 80%
- **操作流畅度**：UI响应时间 < 100ms
- **稳定性**：崩溃率 < 1%

---

**文档版本**：v1.1  
**创建日期**：2024年12月  
**最后更新**：2024年12月  
**负责人**：开发团队